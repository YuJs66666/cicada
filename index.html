<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>暗夜猎手：蝉 - 视觉剧情进化版</title>
    <style>
        body { margin: 0; background: #000; color: #1a4d1a; font-family: 'STHeiti', 'Microsoft YaHei', sans-serif; overflow: hidden; height: 100vh; cursor: none; }
        #info { position: absolute; top: 30px; text-align: center; pointer-events: none; width: 100%; z-index: 10; }
        #msg { font-size: 24px; color: #6aff6a; letter-spacing: 5px; text-shadow: 0 0 15px #000; transition: all 0.8s ease-out; /* 更平滑的过渡 */ }
        #loader { color: #555; font-size: 14px; }
        .stats { margin-top: 15px; font-size: 14px; color: #2d5a2d; opacity: 0.7; }
        canvas { display: block; }
    </style>
</head>
<body>

<div id="info">
    <div id="loader">感知森林的呼吸...</div>
    <div id="msg" style="display:none;">[ 点击屏幕 屏息凝神 ]</div>
    <div id="stats" style="display:none;" class="stats">
        深处: <span id="lvl">1</span> 层 | 标本: <span id="score">0</span>/3
    </div>
</div>
<canvas id="gameCanvas"></canvas>

<script>
/**
 * 暗夜猎手 - 视觉剧情进化版
 * 核心功能：
 * 1. 声音：HRTF 3D 空间定位，蝉鸣/背景音真实采样。
 * 2. 视觉：动态萤火虫、手电光晕、呼吸准星、捕获闪光。
 * 3. 机制：未击中触发“惊飞”，关卡难度递增。
 * 4. 剧情：关卡切换时显示剧情文字。
 */

let audioCtx, forestBuffer, cicadaBuffer;
let bgNode, cicadaNode, panner, cicadaGain;
let isPlaying = false, level = 1, caughtInLevel = 0;
let cicadaPos = { x: 5, z: 0 }; 
let listenerAngle = 0, mouseX = 0, mouseY = 0;
let flashOpacity = 0; // 用于捕获时的闪光效果

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const msgEl = document.getElementById('msg');
const statsEl = document.getElementById('stats');

// --- 配置区：请确保文件名正确 ---
const BG_URL = 'bg.mp3';      
const CICADA_URL = 'cicada.mp3'; 

// --- 剧情文本配置 ---
const levelMessages = [
    "夏夜的鸣叫，是森林的呼吸。",
    "露水打湿了鞋尖，你正走入禁区。",
    "除了蝉鸣，你似乎听到了别的东西...",
    "空气冷得凝固，黑暗深处潜藏着未知。",
    "你的听觉，是唯一的光芒。",
    "这里，时间仿佛停止了。",
    "每一步，都踏在无声的恐惧之上。",
    "更深之处，是等待，还是终结？",
    "你已成为黑暗的一部分。",
    "恭喜你，成为了真正的暗夜猎手。" // 假设第10关是最终关
];

// --- 萤火虫粒子系统 ---
let particles = [];
const NUM_PARTICLES = 30; // 萤火虫数量

function initParticles() {
    for(let i = 0; i < NUM_PARTICLES; i++) {
        particles.push({
            x: Math.random() * window.innerWidth,
            y: Math.random() * window.innerHeight,
            s: Math.random() * 1.5 + 0.5, // 大小 0.5 到 2
            vx: (Math.random() - 0.5) * 0.4, // 速度 -0.2 到 0.2
            vy: (Math.random() - 0.5) * 0.4,
            opacity: Math.random() * 0.5 + 0.2 // 亮度 0.2 到 0.7
        });
    }
}

// 初始化画布
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();


async function loadSounds() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const loader = document.getElementById('loader');
    
    try {
        const [bgRes, cicadaRes] = await Promise.all([
            fetch(BG_URL).then(r => { if(!r.ok) throw new Error("背景音"); return r.arrayBuffer(); }),
            fetch(CICADA_URL).then(r => { if(!r.ok) throw new Error("蝉鸣音"); return r.arrayBuffer(); })
        ]);

        forestBuffer = await audioCtx.decodeAudioData(bgRes);
        cicadaBuffer = await audioCtx.decodeAudioData(cicadaRes);

        loader.style.display = 'none';
        msgEl.style.display = 'block';
    } catch (e) {
        loader.innerHTML = `<span style='color:red;'>音频加载失败: ${e.message}</span><br>请检查文件名 bg.mp3 和 cicada.mp3`;
    }
}

function initGame() {
    if (isPlaying) return;
    isPlaying = true;
    msgEl.innerHTML = levelMessages[0]; // 游戏开始显示第一段剧情
    statsEl.style.display = 'block';
    initParticles(); // 初始化萤火虫

    // 播放背景音
    bgNode = audioCtx.createBufferSource();
    bgNode.buffer = forestBuffer;
    bgNode.loop = true;
    let bgGain = audioCtx.createGain();
    bgGain.gain.value = 0.2; // 背景音量
    bgNode.connect(bgGain).connect(audioCtx.destination);
    bgNode.start();

    // 初始化空间音效
    panner = audioCtx.createPanner();
    panner.panningModel = 'HRTF'; 
    panner.distanceModel = 'inverse'; // 距离越远音量衰减越快
    cicadaGain = audioCtx.createGain();
    panner.connect(cicadaGain).connect(audioCtx.destination);

    spawnCicada();
    requestAnimationFrame(gameLoop);
}

function spawnCicada() {
    if(cicadaNode) try { cicadaNode.stop(); } catch(e){}
    
    cicadaNode = audioCtx.createBufferSource();
    cicadaNode.buffer = cicadaBuffer;
    cicadaNode.loop = true;

    const angle = Math.random() * Math.PI * 2;
    cicadaPos.x = Math.sin(angle) * 5;
    cicadaPos.z = Math.cos(angle) * 5;

    // 难度：关卡越高，音量越低，且位置更频繁变动
    let vol = Math.max(0.03, 0.7 - (level * 0.09));
    cicadaGain.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.1);

    cicadaNode.connect(panner);
    cicadaNode.start();
}

function updatePanner() {
    if (!panner) return;
    const rx = cicadaPos.x * Math.cos(listenerAngle) - cicadaPos.z * Math.sin(listenerAngle);
    const rz = cicadaPos.x * Math.sin(listenerAngle) + cicadaPos.z * Math.cos(listenerAngle);
    
    panner.positionX.setTargetAtTime(rx, audioCtx.currentTime, 0.05);
    panner.positionZ.setTargetAtTime(rz, audioCtx.currentTime, 0.05);
}

function handleMiss() {
    msgEl.innerHTML = "！！它受惊，逃逸了！！";
    
    // 模拟声音快速划过并消失
    const startTime = audioCtx.currentTime;
    // 让音源快速移动到很远的地方，模拟逃走
    panner.positionX.linearRampToValueAtTime(cicadaPos.x + (Math.random() > 0.5 ? 20 : -20), startTime + 0.5);
    panner.positionZ.linearRampToValueAtTime(-30, startTime + 0.5); // 快速远离
    cicadaGain.gain.linearRampToValueAtTime(0, startTime + 0.5); // 音量归零

    setTimeout(() => {
        msgEl.innerHTML = "静默片刻，重新搜寻...";
        spawnCicada();
    }, 1500); // 1.5秒后重新生成
}

window.addEventListener('mousemove', (e) => {
    mouseX = e.clientX;
    mouseY = e.clientY;
    if (!isPlaying) return;
    listenerAngle = ((mouseX / canvas.width) - 0.5) * Math.PI * 2;
    updatePanner();
});

window.addEventListener('mousedown', () => {
    if (!audioCtx) { loadSounds(); return; }
    if (!isPlaying) { initGame(); return; }

    const rx = cicadaPos.x * Math.cos(listenerAngle) - cicadaPos.z * Math.sin(listenerAngle);
    const rz = cicadaPos.x * Math.sin(listenerAngle) + cicadaPos.z * Math.cos(listenerAngle);

    // 判定区域：正前方且居中，相对Z值越小（越负）表示越近
    if (rz < -3.5 && Math.abs(rx) < 1.0) { // 精准度要求更高
        catchSuccess();
    } else {
        handleMiss();
    }
});

function catchSuccess() {
    caughtInLevel++;
    document.getElementById('score').innerText = caughtInLevel;
    msgEl.innerHTML = "捕获成功！";
    
    flashOpacity = 0.6; // 捕获时的闪光强度

    if (caughtInLevel >= 3) {
        level++;
        caughtInLevel = 0;
        document.getElementById('lvl').innerText = level;
        // 显示关卡剧情，如果超出了，则显示最后一句话
        msgEl.innerHTML = levelMessages[level -1] || levelMessages[levelMessages.length -1];
        setTimeout(spawnCicada, 2500); // 剧情显示更长时间
    } else {
        setTimeout(spawnCicada, 1000);
    }
}

// 游戏主循环 (视觉效果都在这里绘制)
function gameLoop() {
    // 深邃的背景色，而非纯黑
    ctx.fillStyle = "#010301"; 
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 绘制萤火虫粒子
    particles.forEach(p => {
        p.x += p.vx;
        p.y += p.vy;
        p.opacity = Math.sin(Date.now() / 300 + p.x + p.y) * 0.2 + 0.3; // 亮度呼吸效果

        // 边界反弹
        if(p.x < 0 || p.x > canvas.width) p.vx *= -1;
        if(p.y < 0 || p.y > canvas.height) p.vy *= -1;
        
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.s, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(100, 255, 100, ${p.opacity})`; // 绿色萤火虫
        ctx.shadowBlur = 5;
        ctx.shadowColor = `rgba(100, 255, 100, ${p.opacity})`;
        ctx.fill();
        ctx.shadowBlur = 0; // 重置阴影，避免影响其他元素
    });

    // 绘制“手电筒”光晕 - 动态且更柔和
    let grad = ctx.createRadialGradient(mouseX, mouseY, 0, mouseX, mouseY, 280);
    grad.addColorStop(0, "rgba(40, 80, 40, 0.1)"); // 中心微绿
    grad.addColorStop(0.5, "rgba(10, 20, 10, 0.03)");
    grad.addColorStop(1, "transparent");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 绘制准星 - 加入呼吸般的微颤
    let driftX = Math.sin(Date.now() / 400) * 1; // 左右微移
    let driftY = Math.cos(Date.now() / 500) * 1; // 上下微移
    ctx.strokeStyle = "rgba(74, 147, 74, 0.25)";
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.arc(canvas.width/2 + driftX, canvas.height/2 + driftY, 30, 0, Math.PI*2);
    ctx.moveTo(canvas.width/2 + driftX, canvas.height/2 - 12);
    ctx.lineTo(canvas.width/2 + driftX, canvas.height/2 + 12);
    ctx.moveTo(canvas.width/2 - 12 + driftX, canvas.height/2 + driftY);
    ctx.lineTo(canvas.width/2 + 12 + driftX, canvas.height/2 + driftY);
    ctx.stroke();

    // 捕获时的闪光效果
    if (flashOpacity > 0) {
        ctx.fillStyle = `rgba(150, 255, 150, ${flashOpacity})`; // 绿色闪光
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        flashOpacity -= 0.05; // 快速消退
    }

    requestAnimationFrame(gameLoop);
}

window.onload = loadSounds;
</script>
</body>
</html>

