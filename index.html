<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>暗夜猎手：全资源整合版</title>
    <style>
        body { margin: 0; background: #000; color: #6aff6a; font-family: sans-serif; overflow: hidden; height: 100vh; cursor: crosshair; }
        
        /* 1. 确保背景图层正确引用了 forest.jpg */
        #bg-layer {
            position: absolute;
            /* 稍微放大背景，防止上下移动时露边 */
            top: -15%; left: -10%; width: 120%; height: 130%;
            background-image: url('forest.jpg'); 
            background-repeat: repeat-x; /* 水平无限循环 */
            background-size: auto 100%; /* 高度撑满，宽度自适应 */
            background-position: 0 50%;
            filter: brightness(0.6) contrast(0.9) blur(1px); /* 朦胧感 */
            z-index: 1;
            will-change: background-position;
        }

        #vignette {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 20%, rgba(0,0,0,0.7) 90%);
            z-index: 2;
            pointer-events: none;
        }

        #ui { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: none; z-index: 10; }
        #msg { font-size: 22px; letter-spacing: 4px; text-shadow: 0 0 15px #000; text-align: center; white-space: pre-line; }
        #btn-start { pointer-events: auto; cursor: pointer; border: 1px solid #1a4d1a; padding: 15px 30px; background: rgba(0,40,0,0.8); color: #6aff6a; margin-top: 20px; display: none; font-size: 18px; }
        .stats { position: absolute; bottom: 30px; font-size: 14px; opacity: 0.8; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 5; }
    </style>
</head>
<body>

<div id="bg-layer"></div>
<div id="vignette"></div>

<div id="ui">
    <div id="msg">正在加载你的资源...\n(forest.jpg, bg.mp3, cicada.mp3)</div>
    <div id="btn-start">进入蝉鸣森林</div>
    <div id="stats-panel" class="stats" style="display:none;">
        探索深度: <span id="lvl">1</span> | 剩余蝉数: <span id="score">0</span>
    </div>
</div>
<canvas id="gameCanvas"></canvas>

<script>
/**
 * 配置区：在这里调整灵敏度
 */
const CONFIG = {
    SENSITIVITY_X: 0.015,  // 左右转头灵敏度
    VERTICAL_LIMIT: 0.6,   // 上下抬头极限
    DEADZONE: 0.1,         // 中心不旋转区域
    CATCH_ACCURACY: 0.3    // 捕捉判定范围
};

const state = {
    audio: null, bgBuffer: null, targetBuffer: null,
    isPlaying: false, level: 1, heading: 0, pitch: 0,
    cicadas: [], mouseX: 0, mouseY: 0, flash: 0,
    bgOffset: { x: 0, y: 50 } // 背景偏移量
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const bgLayer = document.getElementById('bg-layer');
const btnStart = document.getElementById('btn-start');

// 资源加载逻辑
async function loadResources() {
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        state.audio = new AudioContext();
        
        // 确保文件名完全匹配：bg.mp3, cicada.mp3
        const [bgRes, targetRes] = await Promise.all([
            fetch('bg.mp3').then(r => r.arrayBuffer()),
            fetch('cicada.mp3').then(r => r.arrayBuffer())
        ]);

        state.bgBuffer = await state.audio.decodeAudioData(bgRes);
        state.targetBuffer = await state.audio.decodeAudioData(targetRes);

        document.getElementById('msg').innerText = "360° 全维度空间已就绪\n请戴上耳机体验";
        btnStart.style.display = "block";
    } catch (e) {
        document.getElementById('msg').innerText = "加载失败！请检查:\n1. 文件名是否为 forest.jpg, bg.mp3, cicada.mp3\n2. 是否已上传到 GitHub 根目录";
    }
}

// 核心渲染与逻辑循环
function gameLoop() {
    if (state.isPlaying) {
        // --- 1. 处理视角逻辑 ---
        let offsetX = (state.mouseX / window.innerWidth - 0.5) * 2;
        if (Math.abs(offsetX) < CONFIG.DEADZONE) offsetX = 0;
        state.heading += offsetX * CONFIG.SENSITIVITY_X;

        let offsetY = (state.mouseY / window.innerHeight - 0.5) * 2;
        state.pitch = -offsetY * CONFIG.VERTICAL_LIMIT;

        // --- 2. 处理图片位移逻辑 (关键修复) ---
        // 水平：根据 heading 计算偏移像素
        state.bgOffset.x -= offsetX * CONFIG.SENSITIVITY_X * 2000; 
        // 垂直：根据 pitch 映射到 0% - 100% 的背景位置
        state.bgOffset.y = 50 + (state.pitch * 30); 
        
        // 应用到 DOM 元素
        bgLayer.style.backgroundPosition = `${state.bgOffset.x}px ${state.bgOffset.y}%`;
        
        // --- 3. 处理声音定位 ---
        updateCicadasAudio();
    }

    // --- 4. 绘制 Canvas 手电筒特效 ---
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    let g = ctx.createRadialGradient(state.mouseX, state.mouseY, 0, state.mouseX, state.mouseY, 200);
    g.addColorStop(0, "rgba(150,255,150,0.1)");
    g.addColorStop(1, "transparent");
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    if (state.flash > 0) {
        ctx.fillStyle = `rgba(255,255,255,${state.flash})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        state.flash -= 0.05;
    }
    requestAnimationFrame(gameLoop);
}

// 蝉的生成与管理
function spawnCicadas() {
    state.cicadas.forEach(c => { c.source.stop(); });
    state.cicadas = [];
    const count = 2 + state.level; 
    for(let i=0; i<count; i++) {
        const angle = Math.random() * Math.PI * 2;
        const dist = 5;
        const c = {
            pos: {
                x: Math.sin(angle) * dist,
                y: (Math.random() - 0.5) * 8,
                z: Math.cos(angle) * dist
            },
            source: state.audio.createBufferSource(),
            panner: state.audio.createPanner(),
            gain: state.audio.createGain()
        };
        c.source.buffer = state.targetBuffer;
        c.source.loop = true;
        c.panner.panningModel = 'HRTF';
        c.gain.gain.value = 0.3 + Math.random() * 0.4;
        c.source.connect(c.panner).connect(c.gain).connect(state.audio.destination);
        c.source.start(state.audio.currentTime + Math.random() * 2);
        state.cicadas.push(c);
    }
    updateStats();
}

function updateCicadasAudio() {
    state.cicadas.forEach(c => {
        const hCos = Math.cos(-state.heading);
        const hSin = Math.sin(-state.heading);
        let x = c.pos.x * hCos - c.pos.z * hSin;
        let z = c.pos.x * hSin + c.pos.z * hCos;

        const pCos = Math.cos(-state.pitch);
        const pSin = Math.sin(-state.pitch);
        let y = c.pos.y * pCos - z * pSin;
        z = c.pos.y * pSin + z * pCos;

        c.panner.positionX.setTargetAtTime(x, state.audio.currentTime, 0.1);
        c.panner.positionY.setTargetAtTime(y, state.audio.currentTime, 0.1);
        c.panner.positionZ.setTargetAtTime(z, state.audio.currentTime, 0.1);
    });
}

function updateStats() {
    document.getElementById('score').innerText = state.cicadas.length;
    document.getElementById('lvl').innerText = state.level;
}

// 事件监听
window.addEventListener('mousedown', () => {
    if (!state.isPlaying) return;
    let hitIdx = -1;
    state.cicadas.forEach((c, i) => {
        const angleH = Math.atan2(c.pos.x, c.pos.z);
        const angleV = Math.atan2(c.pos.y, Math.sqrt(c.pos.x**2 + c.pos.z**2));
        const dH = Math.atan2(Math.sin(angleH - state.heading), Math.cos(angleH - state.heading));
        const dV = angleV - state.pitch;

        if (Math.abs(dH) < CONFIG.CATCH_ACCURACY && Math.abs(dV) < CONFIG.CATCH_ACCURACY) hitIdx = i;
    });

    if (hitIdx !== -1) {
        state.cicadas.splice(hitIdx, 1)[0].source.stop();
        state.flash = 0.5;
        if (state.cicadas.length === 0) {
            state.level++;
            document.getElementById('msg').innerText = "这一带清静了...\n正在走向更深处";
            setTimeout(spawnCicadas, 2000);
        }
        updateStats();
    }
});

btnStart.addEventListener('click', () => {
    state.audio.resume();
    state.isPlaying = true;
    btnStart.style.display = "none";
    document.getElementById('stats-panel').style.display = "block";
    document.getElementById('msg').innerText = "";
    
    const bgS = state.audio.createBufferSource();
    bgS.buffer = state.bgBuffer; bgS.loop = true;
    const g = state.audio.createGain(); g.gain.value = 0.2;
    bgS.connect(g).connect(state.audio.destination);
    bgS.start();

    spawnCicadas();
    gameLoop();
});

window.addEventListener('mousemove', (e) => {
    state.mouseX = e.clientX; state.mouseY = e.clientY;
});
window.addEventListener('resize', () => {
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
});
window.dispatchEvent(new Event('resize'));
window.onload = loadResources;
</script>
</body>
</html>
