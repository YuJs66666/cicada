<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>暗夜猎手：蝉 - 最终重构版</title>
    <style>
        body { margin: 0; background: #000; color: #1a4d1a; font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; overflow: hidden; height: 100vh; cursor: crosshair; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        #msg { font-size: 26px; color: #6aff6a; letter-spacing: 6px; text-align: center; text-shadow: 0 0 20px rgba(0,0,0,0.8); transition: opacity 0.5s; opacity: 1; }
        #loader { font-size: 14px; color: #4a934a; margin-bottom: 20px; }
        .stats { position: absolute; bottom: 40px; font-size: 14px; color: #2d5a2d; letter-spacing: 2px; }
        canvas { display: block; position: absolute; top: 0; left: 0; }
        #click-hint { font-size: 16px; color: #3e8e3e; margin-top: 20px; border: 1px solid #1a4d1a; padding: 10px 20px; pointer-events: auto; cursor: pointer; }
    </style>
</head>
<body>

<div id="ui-layer">
    <div id="loader">系统准备中...</div>
    <div id="msg"></div>
    <div id="click-hint" style="display:none;">[ 踏入森林 ]</div>
    <div id="stats-ui" class="stats" style="display:none;">
        探索深度: <span id="lvl">1</span> | 捕获标本: <span id="score">0</span> / 3
    </div>
</div>
<canvas id="gameCanvas"></canvas>

<script>
/**
 * 核心逻辑重构
 */
const CONFIG = {
    bgAudio: 'bg.mp3',
    targetAudio: 'cicada.mp3',
    targetDistance: 5,
    catchRange: 1.2
};

let game = {
    audioCtx: null,
    panner: null,
    cicadaGain: null,
    bgBuffer: null,
    targetBuffer: null,
    isPlaying: false,
    level: 1,
    score: 0,
    angle: 0,
    cicadaAngle: 0, // 蝉相对于北方的绝对角度
    mouseX: 0,
    mouseY: 0,
    flash: 0
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const msgEl = document.getElementById('msg');
const loaderEl = document.getElementById('loader');
const hintEl = document.getElementById('click-hint');

// 萤火虫粒子
let fireflies = Array.from({length: 25}, () => ({
    x: Math.random() * window.innerWidth,
    y: Math.random() * window.innerHeight,
    vx: (Math.random() - 0.5) * 0.3,
    vy: (Math.random() - 0.5) * 0.3,
    size: Math.random() * 1.5
}));

// 1. 预加载资源
async function preload() {
    try {
        loaderEl.innerText = "正在同步森林波形...";
        const ctxClass = window.AudioContext || window.webkitAudioContext;
        game.audioCtx = new ctxClass();

        const [res1, res2] = await Promise.all([
            fetch(CONFIG.bgAudio).then(r => r.arrayBuffer()),
            fetch(CONFIG.targetAudio).then(r => r.arrayBuffer())
        ]);

        game.bgBuffer = await game.audioCtx.decodeAudioData(res1);
        game.targetBuffer = await game.audioCtx.decodeAudioData(res2);

        loaderEl.style.display = 'none';
        hintEl.style.display = 'block';
        msgEl.innerText = "声音已就绪";
    } catch (err) {
        loaderEl.innerHTML = "<span style='color:#ff4444'>资源加载失败</span><br>请确保 bg.mp3 和 cicada.mp3 在同一文件夹下";
        console.error(err);
    }
}

// 2. 启动游戏
function start() {
    if (game.isPlaying) return;
    
    // 关键：恢复音频上下文（解决浏览器政策）
    if (game.audioCtx.state === 'suspended') {
        game.audioCtx.resume();
    }

    game.isPlaying = true;
    hintEl.style.display = 'none';
    document.getElementById('stats-ui').style.display = 'block';
    msgEl.innerText = "闭上眼，寻找鸣叫的方向";

    // 播放环境音
    const bgSource = game.audioCtx.createBufferSource();
    bgSource.buffer = game.bgBuffer;
    bgSource.loop = true;
    const bgGain = game.audioCtx.createGain();
    bgGain.gain.value = 0.2;
    bgSource.connect(bgGain).connect(game.audioCtx.destination);
    bgSource.start();

    // 空间节点设置
    game.panner = game.audioCtx.createPanner();
    game.panner.panningModel = 'HRTF';
    game.cicadaGain = game.audioCtx.createGain();
    game.panner.connect(game.cicadaGain).connect(game.audioCtx.destination);

    spawn();
    animate();
}

// 3. 生成蝉
function spawn() {
    if (game.targetSource) game.targetSource.stop();
    
    game.targetSource = game.audioCtx.createBufferSource();
    game.targetSource.buffer = game.targetBuffer;
    game.targetSource.loop = true;

    // 随机分配一个角度 (0 - 2PI)
    game.cicadaAngle = Math.random() * Math.PI * 2;
    
    // 设置音量（随关卡减小）
    let v = Math.max(0.05, 0.8 - (game.level * 0.1));
    game.cicadaGain.gain.setTargetAtTime(v, game.audioCtx.currentTime, 0.1);

    game.targetSource.connect(game.panner);
    game.targetSource.start();
    updateAudioSpace();
}

// 4. 更新声音方位
function updateAudioSpace() {
    if (!game.panner) return;
    
    // 计算相对角度：蝉的角度 - 玩家面向的角度
    const relativeAngle = game.cicadaAngle - game.angle;
    
    // 将极坐标转换为直角坐标传给 Panner
    const x = Math.sin(relativeAngle) * CONFIG.targetDistance;
    const z = -Math.cos(relativeAngle) * CONFIG.targetDistance;

    game.panner.positionX.setTargetAtTime(x, game.audioCtx.currentTime, 0.05);
    game.panner.positionZ.setTargetAtTime(z, game.audioCtx.currentTime, 0.05);
}

// 5. 交互处理
window.addEventListener('mousemove', (e) => {
    game.mouseX = e.clientX;
    game.mouseY = e.clientY;
    if (!game.isPlaying) return;
    
    // 鼠标水平位置映射到 360 度 (2PI)
    game.angle = (e.clientX / window.innerWidth - 0.5) * Math.PI * 2;
    updateAudioSpace();
});

hintEl.addEventListener('click', start);

window.addEventListener('mousedown', () => {
    if (!game.isPlaying) return;

    // 判定：如果相对角度接近 0 (指向前方)
    const diff = Math.atan2(Math.sin(game.cicadaAngle - game.angle), Math.cos(game.cicadaAngle - game.angle));
    
    if (Math.abs(diff) < 0.3) { // 约 17 度的判定范围
        capture();
    } else {
        msgEl.innerText = "！！它惊飞了！！";
        game.cicadaGain.gain.setTargetAtTime(0, game.audioCtx.currentTime, 0.05);
        setTimeout(spawn, 1200);
    }
});

function capture() {
    game.score++;
    game.flash = 0.8;
    document.getElementById('score').innerText = game.score;
    
    if (game.score >= 3) {
        game.level++;
        game.score = 0;
        document.getElementById('lvl').innerText = game.level;
        document.getElementById('score').innerText = 0;
        msgEl.innerText = `森林第 ${game.level} 层：这里更安静了...`;
    } else {
        msgEl.innerText = "精准捕获！";
    }
    spawn();
}

// 6. 视觉循环
function animate() {
    ctx.fillStyle = "#020502";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 迷雾效果
    let fog = ctx.createLinearGradient(0, 0, 0, canvas.height);
    fog.addColorStop(0, "rgba(0,10,0,0)");
    fog.addColorStop(1, "rgba(10,25,10,0.3)");
    ctx.fillStyle = fog;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 萤火虫粒子
    fireflies.forEach(p => {
        p.x += p.vx; p.y += p.vy;
        if(p.x < 0 || p.x > canvas.width) p.vx *= -1;
        if(p.y < 0 || p.y > canvas.height) p.vy *= -1;
        ctx.fillStyle = `rgba(100, 255, 100, ${0.2 + Math.random()*0.3})`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
        ctx.fill();
    });

    // 鼠标光晕
    let g = ctx.createRadialGradient(game.mouseX, game.mouseY, 0, game.mouseX, game.mouseY, 200);
    g.addColorStop(0, "rgba(40, 80, 40, 0.12)");
    g.addColorStop(1, "transparent");
    ctx.fillStyle = g;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 成功闪光
    if (game.flash > 0) {
        ctx.fillStyle = `rgba(150, 255, 150, ${game.flash})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        game.flash -= 0.05;
    }

    requestAnimationFrame(animate);
}

window.addEventListener('resize', () => {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
});
window.dispatchEvent(new Event('resize'));

preload();
</script>
</body>
</html>
