<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>暗夜猎手：蝉 - 沉浸进化版</title>
    <style>
        body { margin: 0; background: #000; color: #1a4d1a; font-family: 'STHeiti', 'Microsoft YaHei', sans-serif; overflow: hidden; height: 100vh; cursor: none; }
        #info { position: absolute; top: 30px; text-align: center; pointer-events: none; width: 100%; z-index: 10; }
        #msg { font-size: 22px; color: #4a934a; letter-spacing: 4px; transition: all 0.5s; text-shadow: 0 0 8px #000; }
        #loader { color: #555; font-size: 14px; }
        .stats { margin-top: 15px; font-size: 14px; color: #2d5a2d; opacity: 0.7; }
        canvas { display: block; }
    </style>
</head>
<body>

<div id="info">
    <div id="loader">正在感知森林的呼吸...</div>
    <div id="msg" style="display:none;">[ 点击屏幕 屏息凝神 ]</div>
    <div id="stats" style="display:none;" class="stats">
        深处: <span id="lvl">1</span> 层 | 标本: <span id="score">0</span>/3
    </div>
</div>
<canvas id="gameCanvas"></canvas>

<script>
/**
 * 暗夜猎手 - 核心逻辑说明：
 * 1. 声音：使用 HRTF 模拟空间定位
 * 2. 视觉：Canvas 绘制微弱手电光晕
 * 3. 机制：未击中触发“惊飞”逻辑
 */

let audioCtx, forestBuffer, cicadaBuffer;
let bgNode, cicadaNode, panner, cicadaGain;
let isPlaying = false, level = 1, caughtInLevel = 0;
let cicadaPos = { x: 5, z: 0 }; 
let listenerAngle = 0, mouseX = 0, mouseY = 0;

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- 配置区：请确保文件名正确 ---
const BG_URL = 'bg.mp3';      
const CICADA_URL = 'cicada.mp3'; 

// 初始化画布
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

async function loadSounds() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const loader = document.getElementById('loader');
    
    try {
        const [bgRes, cicadaRes] = await Promise.all([
            fetch(BG_URL).then(r => { if(!r.ok) throw new Error(); return r.arrayBuffer(); }),
            fetch(CICADA_URL).then(r => { if(!r.ok) throw new Error(); return r.arrayBuffer(); })
        ]);

        forestBuffer = await audioCtx.decodeAudioData(bgRes);
        cicadaBuffer = await audioCtx.decodeAudioData(cicadaRes);

        loader.style.display = 'none';
        document.getElementById('msg').style.display = 'block';
    } catch (e) {
        loader.innerHTML = "<span style='color:red;'>加载失败</span><br>确保 bg.mp3 和 cicada.mp3 在同一目录下";
    }
}

function initGame() {
    if (isPlaying) return;
    isPlaying = true;
    document.getElementById('msg').innerHTML = "仔细听... 它在某个方位";
    document.getElementById('stats').style.display = 'block';

    // 播放背景音
    bgNode = audioCtx.createBufferSource();
    bgNode.buffer = forestBuffer;
    bgNode.loop = true;
    let bgGain = audioCtx.createGain();
    bgGain.gain.value = 0.2;
    bgNode.connect(bgGain).connect(audioCtx.destination);
    bgNode.start();

    // 初始化空间音效
    panner = audioCtx.createPanner();
    panner.panningModel = 'HRTF'; // 关键：开启 3D 定位
    cicadaGain = audioCtx.createGain();
    panner.connect(cicadaGain).connect(audioCtx.destination);

    spawnCicada();
    requestAnimationFrame(gameLoop);
}

function spawnCicada() {
    if(cicadaNode) try { cicadaNode.stop(); } catch(e){}
    
    cicadaNode = audioCtx.createBufferSource();
    cicadaNode.buffer = cicadaBuffer;
    cicadaNode.loop = true;

    // 随机一个 360 度的位置
    const angle = Math.random() * Math.PI * 2;
    cicadaPos.x = Math.sin(angle) * 5;
    cicadaPos.z = Math.cos(angle) * 5;

    // 难度：关卡越高，音量越低
    let vol = Math.max(0.05, 0.8 - (level * 0.12));
    cicadaGain.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.1);

    cicadaNode.connect(panner);
    cicadaNode.start();
}

function updatePanner() {
    if (!panner) return;
    // 模拟转头：将物体坐标系旋转
    const rx = cicadaPos.x * Math.cos(listenerAngle) - cicadaPos.z * Math.sin(listenerAngle);
    const rz = cicadaPos.x * Math.sin(listenerAngle) + cicadaPos.z * Math.cos(listenerAngle);
    
    panner.positionX.setTargetAtTime(rx, audioCtx.currentTime, 0.05);
    panner.positionZ.setTargetAtTime(rz, audioCtx.currentTime, 0.05);
}

// 核心逻辑：没抓到时触发“惊飞”
function handleMiss() {
    document.getElementById('msg').innerHTML = "！！它惊飞了！！";
    
    // 模拟声音快速划过并消失
    const startTime = audioCtx.currentTime;
    panner.positionX.linearRampToValueAtTime(30, startTime + 0.8);
    panner.positionZ.linearRampToValueAtTime(-30, startTime + 0.8);
    cicadaGain.gain.linearRampToValueAtTime(0, startTime + 0.8);

    setTimeout(() => {
        document.getElementById('msg').innerHTML = "重新寻找它的声音...";
        spawnCicada();
    }, 1200);
}

window.addEventListener('mousemove', (e) => {
    mouseX = e.clientX;
    mouseY = e.clientY;
    if (!isPlaying) return;
    // 鼠标水平位移对应视角 360 度
    listenerAngle = ((mouseX / canvas.width) - 0.5) * Math.PI * 2;
    updatePanner();
});

window.addEventListener('mousedown', () => {
    if (!audioCtx) { loadSounds(); return; }
    if (!isPlaying) { initGame(); return; }

    const rx = cicadaPos.x * Math.cos(listenerAngle) - cicadaPos.z * Math.sin(listenerAngle);
    const rz = cicadaPos.x * Math.sin(listenerAngle) + cicadaPos.z * Math.cos(listenerAngle);

    // 判定区域：正前方且居中
    if (rz < -3.5 && Math.abs(rx) < 1.0) {
        catchSuccess();
    } else {
        handleMiss();
    }
});

function catchSuccess() {
    caughtInLevel++;
    document.getElementById('score').innerText = caughtInLevel;
    document.getElementById('msg').innerHTML = "精准捕获！";
    
    // 闪光视觉反馈
    flashOpacity = 0.4;

    if (caughtInLevel >= 3) {
        level++;
        caughtInLevel = 0;
        document.getElementById('lvl').innerText = level;
        document.getElementById('msg').innerHTML = "你正向森林深处走去...";
        setTimeout(spawnCicada, 2000);
    } else {
        setTimeout(spawnCicada, 1000);
    }
}

let flashOpacity = 0;
function gameLoop() {
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 绘制手电筒微光
    let grad = ctx.createRadialGradient(mouseX, mouseY, 5, mouseX, mouseY, 200);
    grad.addColorStop(0, "rgba(30, 60, 30, 0.2)");
    grad.addColorStop(1, "transparent");
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // 绘制准星（极淡）
    ctx.strokeStyle = "rgba(74, 147, 74, 0.15)";
    ctx.beginPath();
    ctx.arc(canvas.width/2, canvas.height/2, 25, 0, Math.PI*2);
    ctx.moveTo(canvas.width/2, canvas.height/2 - 10);
    ctx.lineTo(canvas.width/2, canvas.height/2 + 10);
    ctx.stroke();

    // 抓到时的闪光处理
    if (flashOpacity > 0) {
        ctx.fillStyle = `rgba(255, 255, 255, ${flashOpacity})`;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        flashOpacity -= 0.02;
    }

    requestAnimationFrame(gameLoop);
}

window.onload = loadSounds;
</script>
</body>
</html>
