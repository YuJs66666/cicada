<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>暗夜猎手：全维度自定义版</title>
    <style>
        body { margin: 0; background: #000; color: #6aff6a; font-family: sans-serif; overflow: hidden; height: 100vh; cursor: crosshair; }
        
        /* 核心：加载你自己的图片 forest.jpg */
        #bg-layer {
            position: absolute;
            /* 预留出上下移动的缓冲空间 */
            top: -10%; left: -10%; width: 120%; height: 120%;
            background: url('forest.jpg'); 
            background-repeat: repeat-x;
            background-size: auto 100%;
            background-position: 0 50%;
            /* 亮度设为 0.6，既能看清树木又有朦胧感 */
            filter: brightness(0.6) contrast(0.9) blur(1px);
            z-index: 1;
            will-change: background-position;
        }

        #vignette {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center, transparent 20%, rgba(0,0,0,0.7) 90%);
            z-index: 2;
            pointer-events: none;
        }

        #ui { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; pointer-events: none; z-index: 10; }
        #msg { font-size: 22px; letter-spacing: 4px; text-shadow: 0 0 15px #000; text-align: center; white-space: pre-line; }
        #btn-start { pointer-events: auto; cursor: pointer; border: 1px solid #1a4d1a; padding: 15px 30px; background: rgba(0,40,0,0.8); color: #6aff6a; margin-top: 20px; display: none; font-size: 18px; }
        .stats { position: absolute; bottom: 30px; font-size: 14px; opacity: 0.8; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 5; }
    </style>
</head>
<body>

<div id="bg-layer"></div>
<div id="vignette"></div>

<div id="ui">
    <div id="msg">正在加载你上传的森林资源...</div>
    <div id="btn-start">踏入深林</div>
    <div id="stats-panel" class="stats" style="display:none;">
        探索深度: <span id="lvl">1</span> | 捕获: <span id="score">0</span> / 3
    </div>
</div>
<canvas id="gameCanvas"></canvas>

<script>
/**
 * 3D 全维度自定义资源版
 */
const CONFIG = {
    SENSITIVITY_X: 0.015, // 降低了灵敏度，转头更稳
    DEADZONE: 0.1,        // 中心死区
    VERTICAL_LIMIT: 0.6,  // 仰角限制
    BG_X_SPEED: 1500      // 背景水平滚动速度
};

const state = {
    audio: null, panner: null, gain: null, bgBuffer: null, targetBuffer: null,
    isPlaying: false, level: 1, score: 0,
    heading: 0, pitch: 0,
    cicadaPos: { x: 0, y: 0, z: 0 },
    mouseX: 0, mouseY: 0, flash: 0, source: null,
    bgOffset: { x: 0, y: 50 }
};

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const bgLayer = document.getElementById('bg-layer');
const btnStart = document.getElementById('btn-start');

// 1. 加载你自己的音频文件
async function load() {
    try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        state.audio = new AudioContext();
        
        // 分别加载 bg.mp3 和 cicada.mp3
        const [bgRes, targetRes] = await Promise.all([
            fetch('bg.mp3').then(r => { if(!r.ok) throw new Error('找不到 bg.mp3'); return r.arrayBuffer(); }),
            fetch('cicada.mp3').then(r => { if(!r.ok) throw new Error('找不到 cicada.mp3'); return r.arrayBuffer(); })
        ]);

        state.bgBuffer = await state.audio.decodeAudioData(bgRes);
        state.targetBuffer = await state.audio.decodeAudioData(targetRes);

        document.getElementById('msg').innerText = "资源已就绪\n请戴上耳机，寻找蝉鸣的方位";
        btnStart.style.display = "block";



